<html>
  <head></head>
  <body>

    <style>
      body {
        font-size: 3vh;
      }

      a {
        color: white;
      }

      button {
        border: none;
      }

      span.ref {
        border-bottom: 1px solid white;
        cursor: pointer;
      }

      .center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .label {
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 0.5rem;
      }

      .fixed {
        position: fixed;
        z-index: 99;
      }

      nav {
        right: 0;
        min-width: 8em;
        max-width: 50vw;
        display: flex;
        flex-flow: row wrap;
        justify-content: space-around;
      }

      nav > * {
        font-size: 2rem;
        margin: 0 0.2em;
      }

      output svg {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        margin-bottom: 2rem;
        overflow: visible;
      }

      #layerName {
        left: 50%;
        transform: translateX(-50%);
        font-size: 2rem;
      }

      app-menu {
        position: fixed;
        left: 0;
        bottom: 0;
        z-index: 199;
        background-color: rgb(0, 0, 0);
        height: 100vh;
        width: 33rem;
        max-width: 75vw;
        font-size: 2rem;
        color: white;
        box-shadow: rgba(0, 0, 0, 0.5) 10px 0rem 10px -5px;
        transition: transform 200ms;
      }

      app-menu.closed {
        transform: translateX(-100%);
      }

      app-menu ol {
        height: 90%;
        overflow-y: auto;
        margin: 0.5em;
      }

      app-menu li {
        margin: 1em 0;
      }

      app-menu button {
        position: absolute;
        top: 0;
        right: 0;
        transform: translateX(100%);
        font-size: 1em;
      }

      nav svg.circle {
        height: 1em;
        transform: rotate(-90deg);
      }

      nav svg circle {
        fill: none;
        stroke: #ffffff;
        stroke-width: 32%;
        stroke-dasharray: 100;
        stroke-dashoffset: 0;
      }
    </style>

    <app-nav></app-nav>
    <output id="preSvg">
      <app-file-loader class="center"></app-file-loader>
    </output>
    <app-menu class="closed"><app-menu>


    <!-- TAGS / VIEWS -->
    <script type="riot/tag">
      <app-nav>
        <span id="layerName" class="fixed label">preSvg - please choose your svg presentation</span>
        <nav class="fixed label">
          <button disabled onclick="prev()">back</button>
          <button disabled onclick="next()">next</button>
          <div name="slideCounter">
            <span id="currentLayerIndex"></span>/
            <span id="slideCount">{this.slideCount}</span>
          </div>
          <svg viewBox="0 0 64 64" class="circle">
            <circle r="25%" cy="50%" cx="50%"/>
          </svg>
        </nav>

        function init () {
          this.slideCount = app.presentation.slideCount
        }

        this.on('update', init)
      </app-nav>
    </script>

    <script type="riot/tag">
      <app-file-loader>
        <input type="file" ref="loader"/>

        function init () {
          this.refs.loader.addEventListener('change', handleFileSelect, false)
        }
        this.on('mount', init)
      </app-file-loader>
    </script>

    <script type="riot/tag">
      <app-menu>
        <ol id="toc"></ol>
        <button
          class="label"
          onclick="app.trigger('menu.toggle')">
          â–¤ menu
        </button>

        var tag = this
        this.toggleMenu = function (event) {
          if (tag.root.classList.contains('closed')) {
            tag.root.classList.remove('closed')
          } else {
            tag.root.classList.add('closed')
          }
        }
        function hideMenu () {
          if (!tag.root.classList.contains('closed')) {
            tag.root.classList.add('closed')
          }
        }

        //event interface
        app.on('menu.toggle', this.toggleMenu)
        app.on('menu.hide', this.hideMenu)
      </app-menu>
    </script>


    <!-- SCRIPTS -->
    <script src="riot.min.js"></script>

    <script>
      window.app = {}
      riot.observable(app)
    </script>

    <script>
    // TODO
      // PRESENTATION MODEL
      app.Presentation = function () {
        this.slides = [] //svg layers
        this.chapters = [],
        this.currentLayerIndex = 0,
        this.slideCount = null,

        this.extractSlides = function () {
          var name
          var layers = document.querySelectorAll('output svg > g')

          for (var i = 0, length = layers.length; i < length; i++) {
            name = layers[i].attributes['inkscape:label'].value
            switch (name[0]) {
              case '+':
                // show all + layers, don't add to slides. e.g. "+background"
                layers[i].style.display = 'inline'
                continue
              case '.':
                // hide all . layers, don't add to slides. e.g. ".layout"
                layers[i].style.display = 'none'
                continue
              case '#':
                // add # layers to chapters/toc. e.g. "#Overview"
                name = name.slice(1).trim()
                layers[i].attributes['inkscape:label'].value = name
                this.saveAsChapter(layers[i])
                break;
            }
            this.slides.push(layers[i])
          }
        }
        this.hideCurrentLayer = function () {
          this.slides[this.currentLayerIndex].style.display = 'none'
        },
        this.showCurrentLayer = function () {
          this.slides[this.currentLayerIndex].style.display = 'inline'
        },
        this.hideAllLayers = function () {
          for (var i = 0, length = this.slides.length; i < length; i++) {
            this.slides[i].style.display = 'none';
          }
        }
        this.getIndexById = function (id) {
          for (var i = 0, length = app.presentation.slides.length; i < length; i++) {
            if (this.slides[i].id === id) return i
          }
          //nothing found
          return console.error('no index for id ' + id)
        },
        this.setCurrentLayerById = function (idOrIndex) {
          this.hideCurrentLayer()

          var index = idOrIndex
          if (typeof idOrIndex == 'string') {
            index = this.getIndexById(idOrIndex)
          }
          this.currentLayerIndex = index

          //TODO -> UI update in riot way
          var name = this.slides[index].attributes['inkscape:label'].value
          var percentage = (index * 100) / this.slideCount
          document.querySelector('#layerName').innerHTML = name
          document.querySelector('#currentLayerIndex').innerHTML = index + 1 //start count from 1
          document.querySelector('.circle circle').style.strokeDashoffset = -percentage

          this.showCurrentLayer()
        },
        this.setSlideCounter = function () {
          this.slideCount = this.slides.length
          //TODO event
        },
        this.saveAsChapter = function (slide) {
          var chapter = {
            id: slide.id,
            name: slide.attributes['inkscape:label'].value
          }
          this.chapters.push(chapter)
        }
      }
      app.presentation = new app.Presentation()
    </script>

    <script>
      // service functions
      function setBackgroundColor () {
        var bodyNode = document.querySelector('body')
        var pageSettingsNode = document.querySelector('[pagecolor]')
        bodyNode.style.backgroundColor = pageSettingsNode.getAttribute('pagecolor')
      }
      function setTableOfContents () {
        var tocNode = document.querySelector('#toc')
        var item;
        for (var i = 0, length = app.presentation.chapters.length; i < length; i++) {
          //create list item
          item = document.createElement("li")
          //fill item with html
          item.innerHTML = '<span class="ref" data-hash="#'+chapters[i].id+'" onclick="setUrlHash(event)">'+chapters[i].name+'</span>'
          //append list item
          tocNode.appendChild(item)
        }
      }
      function enableButtons () {
        var buttons = document.querySelectorAll('nav button')
        for (var i = 0, length = buttons.length; i < length; i++) {
          buttons[i].disabled = false
        }
      }
      function handleFileSelect(evt) {
        //https://www.html5rocks.com/de/tutorials/file/dndfiles/
        var file = evt.target.files[0]; // FileList object
        // Only process image files.
        if (!file.type.match('image.*')) {
          console.error('only accept image files');
          return;
        }
        var reader = new FileReader();
        // Closure to capture the file information.
        reader.onload = (function(theFile) {
          return function(event) {
            document.getElementById('preSvg').innerHTML = event.target.result;
            setupPresentation();
          };
        })(file);
        // Read in the image file as plain text.
        reader.readAsText(file);
        // Remove focus from input button
        evt.target.blur()
      }
      function handleKeyEvent (event) {
        switch (event.key) {
          case 'Backspace':
            prev()
            break;
          case 'ArrowLeft':
            prev()
            break;
          case 'ArrowUp':
            prev()
            break;
          case 'ArrowRight':
            next()
            break;
          case 'ArrowDown':
            next()
            break;
          case ' ':
            next()
            break;
          case 'Enter':
            next()
            break;
          default:
            console.log('no function for', event.key)
        }
      }
      function hideMenu () {
        var menuNode = document.querySelector('app-menu')
        if (!menuNode.classList.contains('closed')) {
          menuNode.classList.add('closed')
        }
      }
    </script>

    <script>
      // APP CONTROLLER
      var setupPresentation = function () {
        //requires svg file to be inserted
        setBackgroundColor()
        app.presentation.extractSlides()
        app.presentation.setSlideCounter()
        setTableOfContents()
        enableButtons()
        app.presentation.hideAllLayers()
        //set first layer as currentLayer
        app.presentation.setCurrentLayerById(0);
        //set listener for url hash changes
        window.onhashchange = toSlideByCurrentHash;
        riot.update()
      }
      var setUrlHash = function (hash) {
        if (typeof hash === 'object') { //is event
          hash = hash.target.dataset.hash
        }
        window.location.replace(hash)
      }
      var prev = function () {
        var index = app.presentation.currentLayerIndex - 1
        if (index < 0) index = app.presentation.slides.length - 1
        setUrlHash('#' + app.presentation.slides[index].id)
      }
      var next = function () {
        var index = app.presentation.currentLayerIndex + 1
        if (index == app.presentation.slides.length) index = 0
        setUrlHash('#' + app.presentation.slides[index].id)
      }

      var toSlideByCurrentHash = function () {
        app.presentation.setCurrentLayerById(window.location.hash.slice(1))
        hideMenu()
      }

      // INIT
      document.onkeydown = handleKeyEvent
      if (document.querySelector('output svg')) {
        // when opening a previously saved preSVG
        setupPresentation()
      }
      riot.mount('*')

    </script>
  </body>
</html>
