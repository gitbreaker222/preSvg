<html>
  <head></head>
  <body>

    <!-- normalize.css v7.0.0 | MIT License | github.com/necolas/normalize.css -->
    <style>
      /* Document
       ========================================================================== */

      /**
      * 1. Correct the line height in all browsers.
      * 2. Prevent adjustments of font size after orientation changes in
      *    IE on Windows Phone and in iOS.
      */

      html {
      line-height: 1.15; /* 1 */
      -ms-text-size-adjust: 100%; /* 2 */
      -webkit-text-size-adjust: 100%; /* 2 */
      }

      /* Sections
       ========================================================================== */

      /**
      * Remove the margin in all browsers (opinionated).
      */

      body {
      margin: 0;
      }

      /**
      * Add the correct display in IE 9-.
      */

      article,
      aside,
      footer,
      header,
      nav,
      section {
      display: block;
      }

      /**
      * Correct the font size and margin on `h1` elements within `section` and
      * `article` contexts in Chrome, Firefox, and Safari.
      */

      h1 {
      font-size: 2em;
      margin: 0.67em 0;
      }

      /* Grouping content
       ========================================================================== */

      /**
      * Add the correct display in IE 9-.
      * 1. Add the correct display in IE.
      */

      figcaption,
      figure,
      main { /* 1 */
      display: block;
      }

      /**
      * Add the correct margin in IE 8.
      */

      figure {
      margin: 1em 40px;
      }

      /**
      * 1. Add the correct box sizing in Firefox.
      * 2. Show the overflow in Edge and IE.
      */

      hr {
      box-sizing: content-box; /* 1 */
      height: 0; /* 1 */
      overflow: visible; /* 2 */
      }

      /**
      * 1. Correct the inheritance and scaling of font size in all browsers.
      * 2. Correct the odd `em` font sizing in all browsers.
      */

      pre {
      font-family: monospace, monospace; /* 1 */
      font-size: 1em; /* 2 */
      }

      /* Text-level semantics
       ========================================================================== */

      /**
      * 1. Remove the gray background on active links in IE 10.
      * 2. Remove gaps in links underline in iOS 8+ and Safari 8+.
      */

      a {
      background-color: transparent; /* 1 */
      -webkit-text-decoration-skip: objects; /* 2 */
      }

      /**
      * 1. Remove the bottom border in Chrome 57- and Firefox 39-.
      * 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari.
      */

      abbr[title] {
      border-bottom: none; /* 1 */
      text-decoration: underline; /* 2 */
      text-decoration: underline dotted; /* 2 */
      }

      /**
      * Prevent the duplicate application of `bolder` by the next rule in Safari 6.
      */

      b,
      strong {
      font-weight: inherit;
      }

      /**
      * Add the correct font weight in Chrome, Edge, and Safari.
      */

      b,
      strong {
      font-weight: bolder;
      }

      /**
      * 1. Correct the inheritance and scaling of font size in all browsers.
      * 2. Correct the odd `em` font sizing in all browsers.
      */

      code,
      kbd,
      samp {
      font-family: monospace, monospace; /* 1 */
      font-size: 1em; /* 2 */
      }

      /**
      * Add the correct font style in Android 4.3-.
      */

      dfn {
      font-style: italic;
      }

      /**
      * Add the correct background and color in IE 9-.
      */

      mark {
      background-color: #ff0;
      color: #000;
      }

      /**
      * Add the correct font size in all browsers.
      */

      small {
      font-size: 80%;
      }

      /**
      * Prevent `sub` and `sup` elements from affecting the line height in
      * all browsers.
      */

      sub,
      sup {
      font-size: 75%;
      line-height: 0;
      position: relative;
      vertical-align: baseline;
      }

      sub {
      bottom: -0.25em;
      }

      sup {
      top: -0.5em;
      }

      /* Embedded content
       ========================================================================== */

      /**
      * Add the correct display in IE 9-.
      */

      audio,
      video {
      display: inline-block;
      }

      /**
      * Add the correct display in iOS 4-7.
      */

      audio:not([controls]) {
      display: none;
      height: 0;
      }

      /**
      * Remove the border on images inside links in IE 10-.
      */

      img {
      border-style: none;
      }

      /**
      * Hide the overflow in IE.
      */

      svg:not(:root) {
      overflow: hidden;
      }

      /* Forms
       ========================================================================== */

      /**
      * 1. Change the font styles in all browsers (opinionated).
      * 2. Remove the margin in Firefox and Safari.
      */

      button,
      input,
      optgroup,
      select,
      textarea {
      font-family: sans-serif; /* 1 */
      font-size: 100%; /* 1 */
      line-height: 1.15; /* 1 */
      margin: 0; /* 2 */
      }

      /**
      * Show the overflow in IE.
      * 1. Show the overflow in Edge.
      */

      button,
      input { /* 1 */
      overflow: visible;
      }

      /**
      * Remove the inheritance of text transform in Edge, Firefox, and IE.
      * 1. Remove the inheritance of text transform in Firefox.
      */

      button,
      select { /* 1 */
      text-transform: none;
      }

      /**
      * 1. Prevent a WebKit bug where (2) destroys native `audio` and `video`
      *    controls in Android 4.
      * 2. Correct the inability to style clickable types in iOS and Safari.
      */

      button,
      html [type="button"], /* 1 */
      [type="reset"],
      [type="submit"] {
      -webkit-appearance: button; /* 2 */
      }

      /**
      * Remove the inner border and padding in Firefox.
      */

      button::-moz-focus-inner,
      [type="button"]::-moz-focus-inner,
      [type="reset"]::-moz-focus-inner,
      [type="submit"]::-moz-focus-inner {
      border-style: none;
      padding: 0;
      }

      /**
      * Restore the focus styles unset by the previous rule.
      */

      button:-moz-focusring,
      [type="button"]:-moz-focusring,
      [type="reset"]:-moz-focusring,
      [type="submit"]:-moz-focusring {
      outline: 1px dotted ButtonText;
      }

      /**
      * Correct the padding in Firefox.
      */

      fieldset {
      padding: 0.35em 0.75em 0.625em;
      }

      /**
      * 1. Correct the text wrapping in Edge and IE.
      * 2. Correct the color inheritance from `fieldset` elements in IE.
      * 3. Remove the padding so developers are not caught out when they zero out
      *    `fieldset` elements in all browsers.
      */

      legend {
      box-sizing: border-box; /* 1 */
      color: inherit; /* 2 */
      display: table; /* 1 */
      max-width: 100%; /* 1 */
      padding: 0; /* 3 */
      white-space: normal; /* 1 */
      }

      /**
      * 1. Add the correct display in IE 9-.
      * 2. Add the correct vertical alignment in Chrome, Firefox, and Opera.
      */

      progress {
      display: inline-block; /* 1 */
      vertical-align: baseline; /* 2 */
      }

      /**
      * Remove the default vertical scrollbar in IE.
      */

      textarea {
      overflow: auto;
      }

      /**
      * 1. Add the correct box sizing in IE 10-.
      * 2. Remove the padding in IE 10-.
      */

      [type="checkbox"],
      [type="radio"] {
      box-sizing: border-box; /* 1 */
      padding: 0; /* 2 */
      }

      /**
      * Correct the cursor style of increment and decrement buttons in Chrome.
      */

      [type="number"]::-webkit-inner-spin-button,
      [type="number"]::-webkit-outer-spin-button {
      height: auto;
      }

      /**
      * 1. Correct the odd appearance in Chrome and Safari.
      * 2. Correct the outline style in Safari.
      */

      [type="search"] {
      -webkit-appearance: textfield; /* 1 */
      outline-offset: -2px; /* 2 */
      }

      /**
      * Remove the inner padding and cancel buttons in Chrome and Safari on macOS.
      */

      [type="search"]::-webkit-search-cancel-button,
      [type="search"]::-webkit-search-decoration {
      -webkit-appearance: none;
      }

      /**
      * 1. Correct the inability to style clickable types in iOS and Safari.
      * 2. Change font properties to `inherit` in Safari.
      */

      ::-webkit-file-upload-button {
      -webkit-appearance: button; /* 1 */
      font: inherit; /* 2 */
      }

      /* Interactive
       ========================================================================== */

      /*
      * Add the correct display in IE 9-.
      * 1. Add the correct display in Edge, IE, and Firefox.
      */

      details, /* 1 */
      menu {
      display: block;
      }

      /*
      * Add the correct display in all browsers.
      */

      summary {
      display: list-item;
      }

      /* Scripting
       ========================================================================== */

      /**
      * Add the correct display in IE 9-.
      */

      canvas {
      display: inline-block;
      }

      /**
      * Add the correct display in IE.
      */

      template {
      display: none;
      }

      /* Hidden
       ========================================================================== */

      /**
      * Add the correct display in IE 10-.
      */

      [hidden] {
      display: none;
      }
    </style>

    <style>
      app {
        width: 100vw;
        height: 100vh;
        position: absolute;
        font-size: 3vh;
        overflow: scroll;
      }

      a {
        color: white;
      }

      button {
        border: none;
      }

      span.ref {
        border-bottom: 1px solid white;
        cursor: pointer;
      }

      .center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .label {
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 0.5rem;
      }

      .fixed {
        position: fixed;
        z-index: 99;
      }

      nav {
        right: 0;
        min-width: 8em;
        max-width: 50vw;
        display: flex;
        flex-flow: row wrap;
        justify-content: space-around;
      }

      nav > * {
        font-size: 2rem;
        margin: 0 0.2em;
      }

      output svg {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        margin-bottom: 2rem;
        overflow: visible;
      }
      svg:not(:root) {
        overflow: visible;
      }

      #layerName {
        left: 50%;
        transform: translateX(-50%);
        font-size: 2rem;
      }

      app-menu {
        position: fixed;
        left: 0;
        bottom: 0;
        z-index: 199;
        background-color: rgb(0, 0, 0);
        height: 100vh;
        width: 33rem;
        max-width: 75vw;
        font-size: 2rem;
        color: white;
        box-shadow: rgba(0, 0, 0, 0.5) 10px 0rem 10px -5px;
        transition: transform 200ms;
      }

      app-menu.closed {
        transform: translateX(-100%);
      }

      app-menu ol {
        height: 90%;
        overflow-y: auto;
        margin: 0.5em;
      }

      app-menu li {
        margin: 1em 0;
      }

      app-menu button {
        position: absolute;
        top: 0;
        right: 0;
        transform: translateX(100%);
        font-size: 1em;
      }

      nav svg.circle {
        height: 1em;
        transform: rotate(-90deg);
      }

      nav svg circle {
        fill: none;
        stroke: #ffffff;
        stroke-width: 32%;
        stroke-dasharray: 100;
        stroke-dashoffset: 0;
      }
    </style>

    <app></app>

    <script type="riot/tag">
      <app style={ styles }>
        <app-nav></app-nav>
        <output id="preSvg">
          <app-file-loader class="center"></app-file-loader>
        </output>
        <app-menu class="closed"><app-menu>

        this.styles = {
          'background-color' : '#fff'
        }

        this.setBackgroundColor = function () {
          var pageSettingsNode = document.querySelector('[pagecolor]')
          this.styles['background-color'] = pageSettingsNode.getAttribute('pagecolor')
        }

        this.on('update', function () {
          this.setBackgroundColor()
        })

      </app>
    </script>

    <!-- TAGS / VIEWS -->
    <script type="riot/tag">
      <app-nav>
        <span id="layerName" class="fixed label">preSvg - please choose your svg presentation</span>
        <nav class="fixed label">
          <button disabled onclick="prev()">back</button>
          <button disabled onclick="next()">next</button>
          <div name="slideCounter">
            <span id="currentLayerIndex"></span>/
            <span id="slideCount">{this.slideCount}</span>
          </div>
          <svg viewBox="0 0 64 64" class="circle">
            <circle r="25%" cy="50%" cx="50%"/>
          </svg>
        </nav>

        function init () {
          this.slideCount = app.presentation.slideCount
        }

        this.on('update', init)
      </app-nav>
    </script>

    <script type="riot/tag">
      <app-file-loader>
        <input type="file" ref="loader"/>

        function init () {
          this.refs.loader.addEventListener('change', handleFileSelect, false)
        }
        this.on('mount', init)
      </app-file-loader>
    </script>

    <script type="riot/tag">
      <app-menu>
        <ol id="toc"></ol>
        <button
          class="label"
          onclick="app.trigger('menu.toggle')">
          ▤ menu
        </button>

        var tag = this
        this.toggleMenu = function (event) {
          if (tag.root.classList.contains('closed')) {
            tag.root.classList.remove('closed')
          } else {
            tag.root.classList.add('closed')
          }
        }
        function hideMenu () {
          if (!tag.root.classList.contains('closed')) {
            tag.root.classList.add('closed')
          }
        }

        //event interface
        app.on('menu.toggle', this.toggleMenu)
        app.on('menu.hide', this.hideMenu)
      </app-menu>
    </script>


    <!-- SCRIPTS -->
    <script src="riot.min.js"></script>

    <script>
      window.app = {}
      riot.observable(app)
    </script>

    <script>
    // TODO
      // PRESENTATION MODEL
      app.Presentation = function () {
        this.slides = [] //svg layers
        this.chapters = [],
        this.currentLayerIndex = 0,
        this.slideCount = null,

        this.extractSlides = function () {
          var name
          var layers = document.querySelectorAll('output svg > g')

          for (var i = 0, length = layers.length; i < length; i++) {
            name = layers[i].attributes['inkscape:label'].value
            switch (name[0]) {
              case '+':
                // show all + layers, don't add to slides. e.g. "+background"
                layers[i].style.display = 'inline'
                continue
              case '.':
                // hide all . layers, don't add to slides. e.g. ".layout"
                layers[i].style.display = 'none'
                continue
              case '#':
                // add # layers to chapters/toc. e.g. "#Overview"
                name = name.slice(1).trim()
                layers[i].attributes['inkscape:label'].value = name
                this.saveAsChapter(layers[i])
                break;
            }
            this.slides.push(layers[i])
          }
        }
        this.hideCurrentLayer = function () {
          this.slides[this.currentLayerIndex].style.display = 'none'
        },
        this.showCurrentLayer = function () {
          this.slides[this.currentLayerIndex].style.display = 'inline'
        },
        this.hideAllLayers = function () {
          for (var i = 0, length = this.slides.length; i < length; i++) {
            this.slides[i].style.display = 'none';
          }
        }
        this.getIndexById = function (id) {
          for (var i = 0, length = app.presentation.slides.length; i < length; i++) {
            if (this.slides[i].id === id) return i
          }
          //nothing found
          return console.error('no index for id ' + id)
        },
        this.setCurrentLayerById = function (idOrIndex) {
          this.hideCurrentLayer()

          var index = idOrIndex
          if (typeof idOrIndex == 'string') {
            index = this.getIndexById(idOrIndex)
          }
          this.currentLayerIndex = index

          //TODO -> UI update in riot way
          var name = this.slides[index].attributes['inkscape:label'].value
          var percentage = (index * 100) / this.slideCount
          document.querySelector('#layerName').innerHTML = name
          document.querySelector('#currentLayerIndex').innerHTML = index + 1 //start count from 1
          document.querySelector('.circle circle').style.strokeDashoffset = -percentage

          this.showCurrentLayer()
        },
        this.setSlideCounter = function () {
          this.slideCount = this.slides.length
          //TODO event
        },
        this.saveAsChapter = function (slide) {
          var chapter = {
            id: slide.id,
            name: slide.attributes['inkscape:label'].value
          }
          this.chapters.push(chapter)
        }
      }
      app.presentation = new app.Presentation()
    </script>

    <script>
      // service functions
      function setTableOfContents () {
        var tocNode = document.querySelector('#toc')
        var item;
        for (var i = 0, length = app.presentation.chapters.length; i < length; i++) {
          //create list item
          item = document.createElement("li")
          //fill item with html
          item.innerHTML = '<span class="ref" data-hash="#'+chapters[i].id+'" onclick="setUrlHash(event)">'+chapters[i].name+'</span>'
          //append list item
          tocNode.appendChild(item)
        }
      }
      function enableButtons () {
        var buttons = document.querySelectorAll('nav button')
        for (var i = 0, length = buttons.length; i < length; i++) {
          buttons[i].disabled = false
        }
      }
      function handleFileSelect(evt) {
        //https://www.html5rocks.com/de/tutorials/file/dndfiles/
        var file = evt.target.files[0]; // FileList object
        // Only process image files.
        if (!file.type.match('image.*')) {
          console.error('only accept image files');
          return;
        }
        var reader = new FileReader();
        // Closure to capture the file information.
        reader.onload = (function(theFile) {
          return function(event) {
            document.getElementById('preSvg').innerHTML = event.target.result;
            setupPresentation();
          };
        })(file);
        // Read in the image file as plain text.
        reader.readAsText(file);
        // Remove focus from input button
        evt.target.blur()
      }
      function handleKeyEvent (event) {
        switch (event.key) {
          case 'Backspace':
            prev()
            break;
          case 'ArrowLeft':
            prev()
            break;
          case 'ArrowUp':
            prev()
            break;
          case 'ArrowRight':
            next()
            break;
          case 'ArrowDown':
            next()
            break;
          case ' ':
            next()
            break;
          case 'Enter':
            next()
            break;
          default:
            console.log('no function for', event.key)
        }
      }
      function hideMenu () {
        var menuNode = document.querySelector('app-menu')
        if (!menuNode.classList.contains('closed')) {
          menuNode.classList.add('closed')
        }
      }
    </script>

    <script>
      // APP CONTROLLER
      var setupPresentation = function () {
        //requires svg file to be inserted
        app.presentation.extractSlides()
        app.presentation.setSlideCounter()
        setTableOfContents()
        enableButtons()
        app.presentation.hideAllLayers()
        //set first layer as currentLayer
        app.presentation.setCurrentLayerById(0);
        //set listener for url hash changes
        window.onhashchange = toSlideByCurrentHash;
        riot.update()
      }
      var setUrlHash = function (hash) {
        if (typeof hash === 'object') { //is event
          hash = hash.target.dataset.hash
        }
        window.location.replace(hash)
      }
      var prev = function () {
        var index = app.presentation.currentLayerIndex - 1
        if (index < 0) index = app.presentation.slides.length - 1
        setUrlHash('#' + app.presentation.slides[index].id)
      }
      var next = function () {
        var index = app.presentation.currentLayerIndex + 1
        if (index == app.presentation.slides.length) index = 0
        setUrlHash('#' + app.presentation.slides[index].id)
      }

      var toSlideByCurrentHash = function () {
        app.presentation.setCurrentLayerById(window.location.hash.slice(1))
        hideMenu()
      }

      // INIT
      document.onkeydown = handleKeyEvent
      if (document.querySelector('output svg')) {
        // when opening a previously saved preSVG
        setupPresentation()
      }
      riot.mount('*')

    </script>
  </body>
</html>
